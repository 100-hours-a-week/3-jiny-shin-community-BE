name: Backend CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/ktb-community-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/ktb-community-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "[1] Creating deployment directory..."
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/ktb-backend
            cd /home/${{ secrets.EC2_USERNAME }}/ktb-backend

            echo "[2] Writing .env file..."
            cat > .env << 'EOF'
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            SPRING_PROFILES_ACTIVE=prod
            SPRING_DATASOURCE_URL=jdbc:mysql://${{ secrets.RDS_ENDPOINT }}:3306/ktb_community?useSSL=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            JAVA_OPTS=-Xms512m -Xmx1024m -XX:+UseG1GC
            TZ=Asia/Seoul
            EOF

            chmod 600 .env

            echo "[3] Downloading latest docker-compose.yml..."
            wget -O docker-compose.yml https://raw.githubusercontent.com/100-hours-a-week/3-jiny-shin-community-BE/main/docker-compose.yml

            echo "[4] Stopping previous containers..."
            docker compose down || true

            echo "[5] Pulling latest images..."
            docker compose pull

            echo "[6] Starting containers..."
            docker compose up -d

            echo "[7] Waiting for health check..."
            sleep 10

            for i in {1..20}; do
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Still starting... ($i/20)"
              sleep 5
            done

            echo "Health check FAILED!"
            docker compose logs --tail=100
            exit 1